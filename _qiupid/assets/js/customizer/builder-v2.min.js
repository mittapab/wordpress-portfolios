var CustomizeBuilder_V2;!function(o){var d=o(document),r=wp.customize||null,t=Qiupid_Layout_Builder.is_rtl;CustomizeBuilder_V2=function(c,s){var e={id:s,version:"v2",controlId:"",items:[],container:null,ready:!1,devices:{desktop:"Desktop",mobile:"Mobile/Tablet"},activePanel:"desktop",panels:{},activeRow:"main",draggingItem:null,getTemplate:_.memoize(function(){var n=this,a={evaluate:/<#([\s\S]+?)#>/g,interpolate:/\{\{\{([\s\S]+?)\}\}\}/g,escape:/\{\{([^\}]+?)\}\}(?!\})/g,variable:"data"};return function(e,i,t){return _.isUndefined(i)&&(i="tmpl-customize-control-"+n.type),!_.isUndefined(t)&&_.isString(t)?a.variable=t:a.variable="data",_.template(o("#"+i).html(),null,a)(e)}}),drag_drop:function(){var a=this;o(".qiupid--device-panel",a.container).each(function(){var e=o(this),t=e.data("device"),n=[],e=(o(".col-items",e).each(function(e){var i=o(this).attr("data-id")||"",i=i?"_sid_"+t+"-"+i:"_sid_"+t+e;o(this).attr("id",i),n[e]="#"+i}),o(".col-items, .qiupid-available-items",e).each(function(){o(this).droppable().sortable({placeholder:"sortable-placeholder grid-stack-item",connectWith:".col-items",update:function(){a.save()}})}),o("#_sid_mobile-sidebar",e));e.attr("id");0<e.length&&e.sortable({revert:!0,change:function(e,i){a.save()}})})},addPanel:function(e){var i=this.getTemplate(),t="tmpl-qiupid--cb-panel-v2";if(0!=o("#"+t).length)return _.isObject(c.rows)||(c.rows={}),'<div class="qiupid--device-panel qiupid-vertical-panel qiupid--panel-'+e+'" data-device="'+e+'">'+i({device:e,id:c.id,rows:c.rows},t)+"</div>"},addDevicePanels:function(){var n=this;_.each(n.devices,function(e,i){var t=n.addPanel(i);o(".qiupid--cb-devices-switcher",n.container).append('<a href="#" class="switch-to switch-to-'+i+'" data-device="'+i+'">'+e+"</a>"),o(".qiupid--cb-body",n.container).append(t)}),o("#qiupid-upsell-tmpl").length&&o(o("#qiupid-upsell-tmpl").html()).insertAfter(o(".qiupid--cb-devices-switcher",n.container))},addItem:function(e){var i=this.getTemplate(),t="tmpl-qiupid--cb-item";if(0!=o("#"+t).length)return i=i(e,t),o(i)},addAvailableItems:function(){var c=this;_.each(c.devices,function(e,n){var a=o('<div class="qiupid-available-items" data-device="'+n+'"></div>');o(".qiupid--panel-"+n,c.container).append(a),_.each(c.items,function(e){var i,t=!0;_.isUndefined(e.devices)||_.isEmpty(e.devices)||(_.isString(e.devices)?e.devices!=n&&(t=!1):(i=!1,_.each(e.devices,function(e){n==e&&(i=!0)}),i||(t=!1))),t&&(t=c.addItem(e),a.append(t))})})},switchToDevice:function(e,i){var t=this;1<_.size(t.devices)?(o(".qiupid--cb-devices-switcher a",t.container).removeClass("qiupid--tab-active"),o(".qiupid--cb-devices-switcher .switch-to-"+e,t.container).addClass("qiupid--tab-active"),o(".qiupid--device-panel",t.container).addClass("qiupid--panel-hide"),o(".qiupid--device-panel.qiupid--panel-"+e,t.container).removeClass("qiupid--panel-hide"),t.activePanel=e):o(".qiupid--cb-devices-switcher a",t.container).addClass("qiupid--tab-active"),(_.isUndefined(i)||i)&&o("desktop"==e?"#customize-footer-actions .preview-desktop":"#customize-footer-actions .preview-mobile").trigger("click")},addNewWidget:function(e,i,t,n,a){e=this.container.find(".qiupid--device-panel.qiupid--panel-"+e),i=o(".qiupid--cb-row.qiupid--row-"+i,e),t=o(".col-items.col-"+t,i),i=o('.qiupid-available-items .grid-stack-item[data-id="'+n.id+'"]',e);t.append(i)},addExistingRowsItems:function(){var c=this,t=r.control(c.controlId).params.value;_.isObject(t)||(t={}),_.each(c.devices,function(e,a){var i={};_.isObject(t[a])&&(i=t[a]),_.each(i,function(e,n){_.isUndefined(e)||_.each(e,function(e,t){_.each(e,function(e,i){c.addNewWidget(a,n,t,e,i)})})})}),c.ready=!0},focus:function(){this.container.on("click",".qiupid--cb-item-setting, .qiupid--cb-item-name, .item-tooltip",function(e){e.preventDefault();var e=o(this).data("section")||"",i=o(this).attr("data-control")||"",t=!1;i&&!_.isUndefined(r.control(i))&&(r.control(i).focus(),t=!0),t||e&&!_.isUndefined(r.section(e))&&r.section(e).focus()}),this.container.on("click",".qiupid--cb-row-settings",function(e){e.preventDefault();e=o(this).attr("data-id")||"",e=c.id+"_"+e;_.isUndefined(r.section(e))||r.section(e).focus()})},remove:function(){var t=this;d.on("click",".qiupid--device-panel .qiupid--cb-item-remove",function(e){e.preventDefault();var e=o(this).closest(".grid-stack-item"),i=e.closest(".qiupid--device-panel");e.removeAttr("style"),o(".qiupid-available-items",i).append(e),t.save()})},encodeValue:function(e){return encodeURI(JSON.stringify(e))},decodeValue:function(e){return JSON.parse(decodeURI(e))},save:function(){var a,t=this;t.ready&&(a={},_.each(t.devices,function(e,n){a[n]={};var i=o(".qiupid--panel-"+n,t.container);o(".qiupid--cb-row",i).each(function(){var e=o(this),i=e.attr("data-row-id")||!1,t={};i&&(o(".col-items",e).each(function(){var e=o(this),i=e.attr("data-id")||!1;i&&(e=_.map(o(" > .grid-stack-item",e),function(e){return{id:(e=o(e)).data("id")||""}}),t[i]=e)}),a[n][i]=t)})}),r.control(t.controlId).setting.set(t.encodeValue(a)))},showPanel:function(){var e=this;this.container.removeClass("qiupid--builder--hide").addClass("qiupid--builder-show"),setTimeout(function(){e.container.height();o("#customize-preview").addClass("cb--preview-panel-show")},100)},hidePanel:function(){this.container.removeClass("qiupid--builder-show"),o("#customize-preview").removeClass("cb--preview-panel-show").removeAttr("style")},togglePanel:function(){var i=this;r.state("expandedPanel").bind(function(e){r.panel(c.panel).expanded()?(d.trigger("qiupid_panel_builder_open",[c.panel]),top._current_builder_panel=s,i.showPanel()):i.hidePanel()}),i.container.on("click",".qiupid--panel-close",function(e){e.preventDefault(),i.container.toggleClass("qiupid--builder--hide"),i.container.hasClass("qiupid--builder--hide")?o("#customize-preview").removeClass("cb--preview-panel-show"):o("#customize-preview").addClass("cb--preview-panel-show")})},panelLayoutCSS:function(){var e=o("#customize-controls").width();r.state("paneVisible").get()||(e=0),t?this.container.find(".qiupid--cb-inner").css({"margin-right":e}):this.container.find(".qiupid--cb-inner").css({"margin-left":e})},init:function(e,i,t){var n=this,a=n.getTemplate()(c,"tmpl-qiupid--builder-panel");n.container=o(a),n.container.addClass("qiupid--panel-v2"),o("body .wp-full-overlay").append(n.container),n.controlId=e,n.items=i,n.devices=t,c.section&&r.section(c.section).container.addClass("qiupid--hide"),n.addDevicePanels(),n.switchToDevice(n.activePanel),n.addAvailableItems(),n.switchToDevice(n.activePanel),n.drag_drop(),n.focus(),n.remove(),n.addExistingRowsItems(),r.panel(c.panel).expanded()?n.showPanel():n.hidePanel(),r.previewedDevice.bind(function(e){"desktop"===e?n.switchToDevice("desktop",!1):n.switchToDevice("mobile",!1)}),n.togglePanel(),r.state("paneVisible").get()&&n.panelLayoutCSS(),r.state("paneVisible").bind(function(){n.panelLayoutCSS()}),o(window).resize(_.throttle(function(){n.panelLayoutCSS()},100)),n.container.on("click",".qiupid--cb-devices-switcher a.switch-to",function(e){e.preventDefault();e=o(this).data("device");n.switchToDevice(e)}),d.trigger("qiupid_builder_panel_loaded",[s,n]),o(".grid-stack-item",n.container).addClass("no-tooltip").removeAttr("title")}},i=c.control_id;if(void 0!==c.versions){if(void 0===c.versions[e.version])return alert("Invaild settings"),!1;i=c.versions[e.version].control_id}return e.init(i,c.items,c.devices),e}}(jQuery);